<!DOCTYPE html>
<html lang="en" {% if dark_mode %}class="dark-mode"{% endif %}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Steam Market</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body {% if dark_mode %}class="dark-mode"{% endif %}>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-gear"></i> Settings</h1>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Market
                </a>
            </div>
        </div>

        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> 
            <strong>How to get your Steam cookies (Easiest Method):</strong>
            <ol class="mb-2 mt-2">
                <li><strong>IMPORTANT:</strong> Make sure you're on <code>steamcommunity.com</code> (NOT <code>store.steampowered.com</code>)</li>
                <li><strong>Option A - From Market Listing Page:</strong>
                    <ul>
                        <li>Go to <a href="https://steamcommunity.com/market/listings/730/Danger%20Zone%20Case" target="_blank">Steam Market</a> in your browser (while logged in)</li>
                        <li>Open Developer Tools (F12) → <strong>Network</strong> tab</li>
                        <li>Refresh the page (F5)</li>
                        <li>Find the request to <code>/market/pricehistory/</code> in the Network tab</li>
                        <li>Click on it → <strong>Headers</strong> tab → Scroll to <strong>Request Headers</strong></li>
                        <li>Copy the entire <code>Cookie:</code> header value</li>
                    </ul>
                </li>
                <li><strong>Option B - From Direct API URL (Easier!):</strong>
                    <ul>
                        <li>Open <a href="https://steamcommunity.com/market/pricehistory/?appid=730&market_hash_name=Danger%20Zone%20Case&currency=1" target="_blank">this direct API URL</a> in your browser (while logged in)</li>
                        <li>Open Developer Tools (F12) → <strong>Network</strong> tab</li>
                        <li>Find the request to <code>/market/pricehistory/</code> (it should be the first/only request)</li>
                        <li>Click on it → <strong>Headers</strong> tab → Scroll to <strong>Request Headers</strong></li>
                        <li>Copy the entire <code>Cookie:</code> header value</li>
                    </ul>
                </li>
                <li>Paste the cookie string in the "Cookie String" field below and click "Parse Cookie String"</li>
            </ol>
            <div class="alert alert-warning mb-2 mt-2" role="alert">
                <strong>⚠️ Critical:</strong> Cookies from <code>store.steampowered.com</code> will NOT work! 
                You must get cookies from <code>steamcommunity.com</code>. The token must have audience <code>"web:community"</code>, not <code>"web:store"</code>.
            </div>
            <hr class="my-2">
            <strong>Alternative: Individual Cookies</strong>
            <p class="mb-2">If you prefer, you can also enter cookies individually in the fields below.</p>
            <hr class="my-2">
            <strong>Important Steam Account Requirements:</strong>
            <ul class="mb-0 mt-2">
                <li>Your Steam account must have made a purchase in the last year</li>
                <li>Steam Guard must be enabled on your account</li>
                <li>Your account must have market access enabled</li>
                <li>If you get 400 errors, verify your account meets these requirements</li>
            </ul>
        </div>

        <form id="settingsForm">
            <!-- Steam Cookies Section -->
            <div class="settings-section">
                <h3 class="mb-3">
                    <i class="bi bi-shield-lock"></i> Steam Authentication Cookies
                    <span id="cookiesStatus" class="status-badge status-not-configured ms-2">Not Configured</span>
                </h3>
                <p class="text-muted">Required for fetching price history data from Steam Community Market.</p>
                
                <!-- Cookie String Option (Easiest Method) -->
                <div class="mb-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-magic"></i> <strong>Quick Setup (Recommended)</strong>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">Paste your full cookie string from the browser - we'll extract all cookies automatically!</p>
                            <div class="mb-2">
                                <label for="cookieString" class="form-label">Cookie String</label>
                                <textarea class="form-control font-monospace" 
                                          id="cookieString" 
                                          name="cookieString" 
                                          rows="3"
                                          placeholder="sessionid=...; steamLoginSecure=...; browserid=...; steamCountry=..."></textarea>
                                <div class="help-text">
                                    <strong>How to get this:</strong><br>
                                    1. Go to <a href="https://steamcommunity.com/market/listings/730/Danger%20Zone%20Case" target="_blank">Steam Market</a> in your browser<br>
                                    2. Open DevTools (F12) → Network tab → Refresh page<br>
                                    3. Find request to <code>/market/pricehistory/</code> → Headers → Request Headers<br>
                                    4. Copy the entire <code>Cookie:</code> header value and paste it here
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="parseCookieString()">
                                <i class="bi bi-arrow-down-circle"></i> Parse Cookie String
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearCookieString()">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>

                <hr class="my-4">
                <p class="text-muted"><strong>Or enter cookies manually:</strong></p>
                
                <div class="mb-3">
                    <label for="sessionid" class="form-label">Session ID</label>
                    <input type="text" 
                           class="form-control" 
                           id="sessionid" 
                           name="sessionid" 
                           value="{{ sessionid }}"
                           placeholder="e.g., acc776ba86880c3cca3d9697">
                    <div class="help-text">The <code>sessionid</code> cookie value from steamcommunity.com</div>
                </div>

                <div class="mb-3">
                    <label for="steamLoginSecure" class="form-label">Steam Login Secure</label>
                    <textarea class="form-control" 
                              id="steamLoginSecure" 
                              name="steamLoginSecure" 
                              rows="3"
                              placeholder="e.g., 76561198098290013%7C%7CeyAidHlwIjogIkpXVCIsICJhbGciOiAiRWREU0EiIH0...">{{ steamLoginSecure }}</textarea>
                    <div class="help-text">The <code>steamLoginSecure</code> cookie value from steamcommunity.com</div>
                </div>

                <div class="mb-3">
                    <label for="browserid" class="form-label">Browser ID <span class="text-muted">(Optional)</span></label>
                    <input type="text" 
                           class="form-control" 
                           id="browserid" 
                           name="browserid" 
                           value="{{ browserid }}"
                           placeholder="e.g., 68249548650920601">
                    <div class="help-text">The <code>browserid</code> cookie value (optional, but recommended). Found in browser DevTools → Cookies → steamcommunity.com</div>
                </div>

                <div class="mb-3">
                    <label for="steamCountry" class="form-label">Steam Country <span class="text-muted">(Optional)</span></label>
                    <input type="text" 
                           class="form-control" 
                           id="steamCountry" 
                           name="steamCountry" 
                           value="{{ steamCountry }}"
                           placeholder="e.g., US%7Cac6754462c6d54ce4276921dd1095a73">
                    <div class="help-text">The <code>steamCountry</code> cookie value (optional, but recommended)</div>
                </div>

                <div class="mb-3">
                    <label for="webTradeEligibility" class="form-label">Web Trade Eligibility <span class="text-muted">(Optional)</span></label>
                    <input type="text" 
                           class="form-control" 
                           id="webTradeEligibility" 
                           name="webTradeEligibility" 
                           value="{{ webTradeEligibility }}"
                           placeholder="e.g., %7B%22allowed%22%3A1...">
                    <div class="help-text">The <code>webTradeEligibility</code> cookie value (optional, but recommended)</div>
                </div>
            </div>

            <!-- Appearance Section -->
            <div class="settings-section">
                <h3 class="mb-3">
                    <i class="bi bi-palette"></i> Appearance
                </h3>
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" 
                               type="checkbox" 
                               id="darkModeToggle" 
                               name="dark_mode"
                               {% if dark_mode %}checked{% endif %}>
                        <label class="form-check-label" for="darkModeToggle">
                            <strong>Dark Mode</strong>
                        </label>
                    </div>
                    <div class="help-text">Enable dark mode for a darker color scheme</div>
                </div>
            </div>

            <!-- API Key Section -->
            <div class="settings-section">
                <h3 class="mb-3">
                    <i class="bi bi-key"></i> SteamApis.com API Key
                    <span id="apiKeyStatus" class="status-badge status-not-configured ms-2">Not Configured</span>
                </h3>
                <p class="text-muted">Optional: API key for SteamApis.com service (if you use it).</p>
                
                <div class="mb-3">
                    <label for="steamapis_key" class="form-label">SteamApis.com API Key</label>
                    <input type="text" 
                           class="form-control" 
                           id="steamapis_key" 
                           name="steamapis_key" 
                           value="{{ steamapis_key }}"
                           placeholder="Enter your SteamApis.com API key">
                    <div class="help-text">Your API key from <a href="https://steamapis.com" target="_blank">SteamApis.com</a> (optional)</div>
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <div>
                    <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Defaults
                    </button>
                    <button type="button" class="btn btn-info ms-2" onclick="testCookies()">
                        <i class="bi bi-check-circle"></i> Test Cookies
                    </button>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Save Settings
                </button>
            </div>
        </form>

        <div id="alertContainer" class="mt-3">
            {% if saved %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> Settings saved successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update status badges on page load
        function updateStatusBadges() {
            const sessionid = document.getElementById('sessionid').value.trim();
            const steamLoginSecure = document.getElementById('steamLoginSecure').value.trim();
            const apiKey = document.getElementById('steamapis_key').value.trim();

            const cookiesStatus = document.getElementById('cookiesStatus');
            if (sessionid && steamLoginSecure) {
                cookiesStatus.textContent = 'Configured';
                cookiesStatus.className = 'status-badge status-configured ms-2';
            } else {
                cookiesStatus.textContent = 'Not Configured';
                cookiesStatus.className = 'status-badge status-not-configured ms-2';
            }

            const apiKeyStatus = document.getElementById('apiKeyStatus');
            if (apiKey) {
                apiKeyStatus.textContent = 'Configured';
                apiKeyStatus.className = 'status-badge status-configured ms-2';
            } else {
                apiKeyStatus.textContent = 'Not Configured';
                apiKeyStatus.className = 'status-badge status-not-configured ms-2';
            }
        }

        // Update status badges when inputs change
        document.getElementById('sessionid').addEventListener('input', updateStatusBadges);
        document.getElementById('steamLoginSecure').addEventListener('input', updateStatusBadges);
        document.getElementById('steamapis_key').addEventListener('input', updateStatusBadges);

        // Initial status update
        updateStatusBadges();
        
        // Apply dark mode on page load
        {% if dark_mode %}
        document.documentElement.classList.add('dark-mode');
        document.body.classList.add('dark-mode');
        {% endif %}
        
        // Toggle dark mode immediately when switch is toggled
        document.getElementById('darkModeToggle').addEventListener('change', function() {
            if (this.checked) {
                document.documentElement.classList.add('dark-mode');
                document.body.classList.add('dark-mode');
            } else {
                document.documentElement.classList.remove('dark-mode');
                document.body.classList.remove('dark-mode');
            }
        });

        // Handle form submission
        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const alertContainer = document.getElementById('alertContainer');
            
            // Clear previous alerts
            alertContainer.innerHTML = '';

            fetch('{{ url_for("settings") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            })
            .then(response => {
                // Check if response is OK
                if (!response.ok) {
                    return response.text().then(text => {
                        // Try to parse as JSON, if fails, use text
                        try {
                            return JSON.parse(text);
                        } catch {
                            throw new Error(`Server error: ${response.status} ${response.statusText}`);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                    if (data.message) {
                        alertContainer.innerHTML = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="bi bi-check-circle"></i> ${data.message}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                        updateStatusBadges();
                        
                        // Apply dark mode immediately if changed
                        if (data.dark_mode !== undefined) {
                            if (data.dark_mode) {
                                document.documentElement.classList.add('dark-mode');
                                document.body.classList.add('dark-mode');
                            } else {
                                document.documentElement.classList.remove('dark-mode');
                                document.body.classList.remove('dark-mode');
                            }
                        }
                    } else if (data.error) {
                        alertContainer.innerHTML = `
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="bi bi-exclamation-triangle"></i> ${data.error}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                    }
            })
            .catch(error => {
                alertContainer.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> Error saving settings: ${error.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            });
        });

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset to default values? This will clear your custom settings.')) {
                document.getElementById('sessionid').value = '';
                document.getElementById('steamLoginSecure').value = '';
                document.getElementById('steamapis_key').value = '';
                updateStatusBadges();
            }
        }

        function testCookies() {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-info" role="alert">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Testing cookies...
                </div>
            `;

            fetch('{{ url_for("test_cookies") }}')
                .then(response => response.json())
                .then(data => {
                    if (data.valid) {
                        alertContainer.innerHTML = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="bi bi-check-circle"></i> <strong>Success!</strong> ${data.message}
                                ${data.price_points ? `<br>Retrieved ${data.price_points} price history points for test item.` : ''}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                    } else {
                        alertContainer.innerHTML = `
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="bi bi-exclamation-triangle"></i> <strong>Test Failed:</strong> ${data.error}
                                ${data.details ? `<br><small>${data.details}</small>` : ''}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    alertContainer.innerHTML = `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle"></i> Error testing cookies: ${error.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                });
        }
    </script>
</body>
</html>
